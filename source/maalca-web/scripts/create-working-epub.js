const nodepub = require('nodepub');
const fs = require('fs').promises;
const path = require('path');

async function createWorkingEPUB() {
  const publicDir = path.join(__dirname, '..', 'public', 'books');
  
  try {
    await fs.access(publicDir);
  } catch {
    await fs.mkdir(publicDir, { recursive: true });
  }

  console.log('üìö Creando EPUB funcional con nodepub...');

  // Crear el documento
  const document = nodepub.document({
    id: 'amaranta-demo-2024',
    title: 'Amaranta - Demo',
    author: 'Ciriaco A. Pichardo (CiriWhispers)',
    publisher: 'Editorial MaalCa',
    description: 'Una joven enfrenta el eco de una culpa heredada. Versi√≥n demo para CiriWhispers.',
    language: 'es',
    published: '2024-12-01',
    genre: 'Fiction',
    cover: null // No cover image
  }, path.join(publicDir, 'amaranta-working.epub'));

  // Agregar cap√≠tulos
  document.addSection('Introducci√≥n', `
    <h1>Amaranta - Demo</h1>
    <p><strong>Por Ciriaco A. Pichardo (CiriWhispers)</strong></p>
    <p><em>Una joven enfrenta el eco de una culpa heredada. Entre recuerdos prestados y voces que insisten en hablarle, descubre que amar tambi√©n puede ser una forma de perd√≥n.</em></p>
    <p>Esta es una versi√≥n demo creada especialmente para probar el lector digital integrado en CiriWhispers.</p>
    <hr/>
  `);

  document.addSection('Cap√≠tulo I: El Eco de una Culpa', `
    <h1>Cap√≠tulo I: El Eco de una Culpa</h1>
    
    <p>En la penumbra de su memoria, Amaranta encontr√≥ las palabras que nunca pudo decir en vida. La casa respiraba con el peso de los secretos, y cada rinc√≥n guardaba el eco de una culpa que se transmit√≠a como herencia maldita.</p>
    
    <p>Era una tarde de octubre cuando todo cambi√≥. El viento arrastraba las hojas secas por el patio, creando una sinfon√≠a melanc√≥lica que parec√≠a narrar su propia historia. Amaranta, de apenas diecisiete a√±os, no sab√≠a que ese d√≠a marcar√≠a el inicio de su descenso hacia el laberinto de su propia consciencia.</p>
    
    <p>La carta lleg√≥ esa ma√±ana, sellada con cera roja y con una caligraf√≠a que le resultaba familiar pero que no lograba ubicar. Sus manos temblaron al abrirla, y las palabras que ley√≥ la trasladaron a un pasado que cre√≠a enterrado.</p>
    
    <blockquote>
      <p><em>"Las deudas del alma se pagan con l√°grimas, y las tuyas, querida Amaranta, apenas han comenzado a caer."</em></p>
    </blockquote>
    
    <p>No hab√≠a firma, pero no la necesitaba. Sab√≠a exactamente de qui√©n ven√≠an esas palabras. La voz de su abuela resonaba en cada l√≠nea, como si desde el m√°s all√° le recordara que algunos fantasmas nunca descansan.</p>
    
    <p>La habitaci√≥n se llen√≥ de recuerdos. Ve√≠a a su abuela en la mecedora del porche, cont√°ndole historias de mujeres que amaron demasiado y pagaron el precio de su devoci√≥n. Historias que entonces le parec√≠an cuentos, pero que ahora comprend√≠a eran advertencias.</p>
    
    <p><em>"El amor verdadero"</em>, le hab√≠a dicho la anciana una tarde, mientras tej√≠a un chal que nunca terminar√≠a, <em>"es como el fuego: puede darte calor o consumirte por completo. Y nosotras, las mujeres de esta familia, siempre hemos sido propensas a las llamas."</em></p>
  `);

  document.addSection('Cap√≠tulo II: Voces en el Silencio', `
    <h1>Cap√≠tulo II: Voces en el Silencio</h1>
    
    <p>Las noches se hab√≠an vuelto territorio de voces que nadie m√°s pod√≠a escuchar. Amaranta despertaba sobresaltada, creyendo haber o√≠do su nombre susurrado entre las sombras de su habitaci√≥n.</p>
    
    <p>Era siempre la misma voz: grave, melanc√≥lica, cargada de una tristeza que parec√≠a habitar en los rincones m√°s oscuros de la casa. Una voz que conoc√≠a desde la infancia, pero que ahora la llamaba con una urgencia nueva, desesperada.</p>
    
    <p>Se levantaba de la cama y recorr√≠a los pasillos descalza, siguiendo el eco que la guiaba hacia el desv√°n. All√≠, entre cajas de recuerdos y muebles cubiertos por s√°banas, encontraba siempre el mismo diario abierto en p√°ginas diferentes.</p>
    
    <p>Era el diario de su madre, quien hab√≠a muerto cuando ella apenas ten√≠a cinco a√±os. Las p√°ginas amarillentas conten√≠an confesiones que jam√°s debi√≥ leer, secretos que explicaban por qu√© su padre la miraba a veces con una mezcla de amor y dolor.</p>
    
    <blockquote>
      <p><em>"Hay amores que son condena, y yo he sido condenada a amar a quien no deb√≠a. Mi hija pagar√° por mis pecados, como yo pagu√© por los de mi madre, y su madre por los de la suya. Somos una estirpe de mujeres marcadas por la pasi√≥n ciega."</em></p>
    </blockquote>
    
    <p>Amaranta cerr√≥ el diario con manos temblorosas. Ahora entend√≠a por qu√© las cartas, por qu√© las voces, por qu√© esa sensaci√≥n constante de estar pagando una deuda que no hab√≠a contra√≠do.</p>
    
    <p>Pero hab√≠a algo m√°s. En la √∫ltima p√°gina que hab√≠a le√≠do, su madre mencionaba un lugar: el viejo cementerio a las afueras del pueblo, donde estaba enterrada la primera Amaranta de la familia, aquella de quien hab√≠a heredado el nombre y, aparentemente, la maldici√≥n.</p>
  `);

  document.addSection('Ep√≠logo: El Perd√≥n de las Almas', `
    <h1>Ep√≠logo: El Perd√≥n de las Almas</h1>
    
    <p>El viaje hacia el perd√≥n no tiene mapa ni destino seguro. Amaranta lo aprendi√≥ esa madrugada de noviembre, cuando finalmente tuvo el valor de caminar hasta el cementerio y hablar con los fantasmas de su linaje.</p>
    
    <p>Bajo la luz p√°lida de la luna, encontr√≥ la tumba de la primera Amaranta. La l√°pida, erosionada por el tiempo, apenas dejaba leer: <em>"Amaranta Sol√≠s, 1892-1920. Am√≥ como solo aman las almas perdidas."</em></p>
    
    <p>Se arrodill√≥ sobre la tierra h√∫meda y, por primera vez en meses, habl√≥ en voz alta:</p>
    
    <blockquote>
      <p><em>"No s√© qu√© hiciste, abuela. No s√© qu√© hizo mi madre, ni mi bisabuela, ni todas las que vinieron antes. Pero yo estoy aqu√≠, y estoy cansada de cargar con culpas que no son m√≠as. Si el amor es nuestra maldici√≥n, que sea tambi√©n nuestra redenci√≥n."</em></p>
    </blockquote>
    
    <p>El viento dej√≥ de soplar. Las voces callaron. Y por primera vez en su vida, Amaranta sinti√≥ el silencio no como una amenaza, sino como una promesa.</p>
    
    <p>Cuando regres√≥ a casa, las cartas hab√≠an desaparecido del caj√≥n. En su lugar, encontr√≥ una sola nota, escrita con su propia letra:</p>
    
    <blockquote>
      <p><strong>"El pasado perdona a quien aprende a perdonarse a s√≠ mismo. El futuro espera a quien tiene el valor de escribir su propia historia."</strong></p>
    </blockquote>
    
    <p>Amaranta sonri√≥ por primera vez en meses. La maldici√≥n hab√≠a terminado, no porque alguien la hubiera roto, sino porque ella hab√≠a decidido no heredarla.</p>
    
    <p>Algunas historias de amor terminan en tragedia. La suya, decidi√≥, terminar√≠a en libertad.</p>
    
    <hr/>
    <p style="text-align: center;"><strong>‚Äî Fin ‚Äî</strong></p>
    <p style="text-align: center;"><em>Demo para CiriWhispers Digital Reader</em></p>
  `);

  // Escribir el archivo
  await document.writeEPUB((err) => {
    if (err) {
      console.error('‚ùå Error creating EPUB:', err);
    } else {
      console.log('‚úÖ amaranta-working.epub creado exitosamente');
      console.log('üìÅ Ubicaci√≥n: /public/books/amaranta-working.epub');
    }
  });

  return new Promise((resolve) => {
    setTimeout(resolve, 2000); // Dar tiempo para que termine de escribir
  });
}

if (require.main === module) {
  createWorkingEPUB().catch(console.error);
}

module.exports = { createWorkingEPUB };